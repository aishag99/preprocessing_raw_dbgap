library(TCGAbiolinks)
library(SummarizedExperiment)

# 1. Query + prepare 
query <- GDCquery(
  project       = "TCGA-LUAD",
  data.category = "Transcriptome Profiling",
  data.type     = "Gene Expression Quantification",
  workflow.type = "STAR - Counts" #this is what it is for dbgap data
)

# GDCdownload(query)   # run once, then comment out
se <- GDCprepare(query)

# 2. Expression matrix (genes x samples)
expr_raw <- assay(se)              # rows = genes, cols = samples
datExpr  <- log2(expr_raw + 1)

# 3. Build expression file for SampleNetwork 
# SampleNetwork expects: rows = features, cols = samples,
# with at least 1 feature-info column (e.g. probe_sets)

datExprT <- data.frame(
  probe_sets = rownames(datExpr),  # gene IDs
  datExpr,
  check.names = FALSE
)

# 4. Phenotype / sample info 

pheno <- as.data.frame(colData(se))

sampleInfo <- data.frame(
  Sample_Label = pheno$barcode,   # must match colnames(datExpr)
  Accession    = pheno$sample_id,
  Disease_type = sapply(pheno$disease_type, function(x) paste(x, collapse = "; ")),
  Sex          = pheno$gender,
  Tumor_Stage  = pheno$ajcc_pathologic_stage,
  Tumor_Type   = pheno$classification_of_tumor,
  stringsAsFactors = FALSE
)

# make rows of sampleInfo correspond to sample labels
rownames(sampleInfo) <- sampleInfo$Sample_Label

# 5. Check alignment: expression samples vs sampleInfo rows

stopifnot(identical(colnames(datExprT)[-1], rownames(sampleInfo)))
# col 1 = probe_sets, so drop it with [-1]

# 6. Save CSVs 

write.csv(
  datExprT,
  file = "TCGA_LUAD_expression_matrix_for_SampleNetwork.csv",
  row.names = FALSE
)

write.csv(
  sampleInfo,
  file = "TCGA_LUAD_sampleInfo_for_SampleNetwork.csv",
  row.names = TRUE
)
